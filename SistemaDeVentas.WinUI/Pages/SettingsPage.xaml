<Page
    x:Class="SistemaDeVentas.WinUI.Pages.SettingsPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:local="using:SistemaDeVentas.WinUI.Pages"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    mc:Ignorable="d"
    Background="{ThemeResource ApplicationPageBackgroundThemeBrush}">

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Header -->
        <TextBlock
            Text="Configuración del Sistema"
            FontSize="24"
            FontWeight="SemiBold"
            Margin="20,20,20,10"
            HorizontalAlignment="Left"/>

        <!-- TabView for different configuration sections -->
        <TabView Grid.Row="1" Margin="20,0,20,20">
            <!-- General Settings Tab -->
            <TabViewItem Header="General">
                <ScrollViewer>
                    <StackPanel Margin="20" Spacing="16">
                        <TextBlock Text="Información de la Empresa" FontSize="18" FontWeight="SemiBold" Margin="0,0,0,10"/>

                        <TextBox
                            Header="Nombre de la Empresa"
                            Text="{x:Bind ViewModel.CompanyName, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                            PlaceholderText="Ingrese el nombre de la empresa"/>
                        <TextBox
                            Header="RUT de la Empresa"
                            Text="{x:Bind ViewModel.CompanyRUT, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                            PlaceholderText="Ej: 76192083-9"/>
                        <TextBox
                            Header="Dirección"
                            Text="{x:Bind ViewModel.CompanyAddress, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                            PlaceholderText="Dirección de la empresa"/>
                        <TextBox
                            Header="Teléfono"
                            Text="{x:Bind ViewModel.CompanyPhone, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                            PlaceholderText="Teléfono de contacto"/>
                        <TextBox
                            Header="Email"
                            Text="{x:Bind ViewModel.CompanyEmail, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                            PlaceholderText="Email de contacto"/>
                    </StackPanel>
                </ScrollViewer>
            </TabViewItem>

            <!-- MercadoPago Settings Tab -->
            <TabViewItem Header="MercadoPago">
                <ScrollViewer>
                    <StackPanel Margin="20" Spacing="16">
                        <TextBlock Text="Configuración de MercadoPago" FontSize="18" FontWeight="SemiBold" Margin="0,0,0,10"/>
                        <InfoBar
                            Title="Información Importante"
                            Message="Para obtener estas credenciales, visite https://www.mercadopago.cl/developers y cree una aplicación."
                            Severity="Informational"
                            IsOpen="True"
                            Margin="0,0,0,10"/>

                        <TextBox
                            Header="Access Token"
                            Text="{x:Bind ViewModel.MercadoPagoAccessToken, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                            PlaceholderText="APP_USR-..."/>
                        <TextBox
                            Header="Terminal ID"
                            Text="{x:Bind ViewModel.MercadoPagoTerminalId, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                            PlaceholderText="ID del terminal POS"/>
                        <TextBox
                            Header="URL Base de API"
                            Text="{x:Bind ViewModel.MercadoPagoBaseUrl, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                            PlaceholderText="https://api.mercadopago.com"/>
                        <NumberBox
                            Header="Timeout (segundos)"
                            Value="{x:Bind ViewModel.MercadoPagoTimeoutSeconds, Mode=TwoWay}"
                            Minimum="5"
                            Maximum="300"/>
                        <TextBox
                            Header="Moneda por Defecto"
                            Text="{x:Bind ViewModel.MercadoPagoDefaultCurrency, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                            PlaceholderText="CLP"/>
                    </StackPanel>
                </ScrollViewer>
            </TabViewItem>

            <!-- DTE/SII Settings Tab -->
            <TabViewItem Header="DTE/SII">
                <ScrollViewer>
                    <StackPanel Margin="20" Spacing="16">
                        <TextBlock Text="Configuración de Documentos Tributarios Electrónicos" FontSize="18" FontWeight="SemiBold" Margin="0,0,0,10"/>
                        <InfoBar
                            Title="Información de Seguridad"
                            Message="Los certificados digitales son necesarios para firmar los DTE. Consulte con su proveedor de certificados."
                            Severity="Warning"
                            IsOpen="True"
                            Margin="0,0,0,10"/>

                        <ComboBox
                            Header="Ambiente"
                            SelectedValue="{x:Bind ViewModel.Ambiente, Mode=TwoWay}"
                            Margin="0,0,0,10">
                            <ComboBoxItem Content="Certificación" Tag="certificacion"/>
                            <ComboBoxItem Content="Producción" Tag="produccion"/>
                        </ComboBox>

                        <TextBlock Text="Credenciales SII" FontSize="16" FontWeight="SemiBold" Margin="0,10,0,5"/>
                        <TextBox
                            Header="Usuario SII"
                            Text="{x:Bind ViewModel.SiiUsername, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                            PlaceholderText="Usuario del Servicio de Impuestos Internos"/>
                        <PasswordBox
                            Header="Contraseña SII"
                            Password="{x:Bind ViewModel.SiiPassword, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                            PlaceholderText="Contraseña del SII"/>

                        <TextBlock Text="Certificado Digital" FontSize="16" FontWeight="SemiBold" Margin="0,20,0,5"/>
                        <TextBox
                            Header="Ruta del Certificado"
                            Text="{x:Bind ViewModel.CertificatePath, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                            PlaceholderText="C:\certificados\certificado.p12"/>
                        <PasswordBox
                            Header="Contraseña del Certificado"
                            Password="{x:Bind ViewModel.CertificatePassword, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                            PlaceholderText="Contraseña del certificado"/>

                        <TextBlock Text="Datos del Emisor" FontSize="16" FontWeight="SemiBold" Margin="0,20,0,5"/>
                        <TextBox
                            Header="RUT Emisor"
                            Text="{x:Bind ViewModel.RutEmisor, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                            PlaceholderText="RUT del emisor (ej: 76192083-9)"/>
                        <TextBox
                            Header="Razón Social"
                            Text="{x:Bind ViewModel.RazonSocial, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                            PlaceholderText="Nombre legal de la empresa"/>
                        <TextBox
                            Header="Giro"
                            Text="{x:Bind ViewModel.GiroEmisor, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                            PlaceholderText="Giro comercial de la empresa"/>
                        <NumberBox
                            Header="Actividad Económica"
                            Value="{x:Bind ViewModel.ActividadEconomica, Mode=TwoWay}"
                            Minimum="0"/>
                        <TextBox
                            Header="Dirección Origen"
                            Text="{x:Bind ViewModel.DireccionOrigen, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                            PlaceholderText="Dirección de origen de los documentos"/>
                        <TextBox
                            Header="Comuna Origen"
                            Text="{x:Bind ViewModel.ComunaOrigen, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                            PlaceholderText="Comuna de origen"/>
                    </StackPanel>
                </ScrollViewer>
            </TabViewItem>

            <!-- Users Management Tab -->
            <TabViewItem Header="Usuarios">
                <ScrollViewer>
                    <StackPanel Margin="20" Spacing="16">
                        <TextBlock Text="Gestión de Usuarios" FontSize="18" FontWeight="SemiBold" Margin="0,0,0,10"/>

                        <!-- Search and Actions -->
                        <StackPanel Orientation="Horizontal" Spacing="10" Margin="0,0,0,15">
                            <TextBox
                                Header="Buscar usuarios"
                                Text="{x:Bind UserManagementViewModel.SearchTerm, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                PlaceholderText="Nombre, usuario o email"
                                Width="300"/>
                            <Button
                                Content="Refrescar"
                                Command="{x:Bind UserManagementViewModel.RefreshCommand}"
                                VerticalAlignment="Bottom"/>
                        </StackPanel>

                        <!-- Users List -->
                        <ListView
                            ItemsSource="{x:Bind UserManagementViewModel.Users}"
                            SelectedItem="{x:Bind UserManagementViewModel.SelectedUser, Mode=TwoWay}"
                            Height="200"
                            Margin="0,0,0,15">
                            <ListView.ItemTemplate>
                                <DataTemplate>
                                    <StackPanel Orientation="Horizontal" Spacing="10">
                                        <TextBlock Text="{Binding DisplayName}" FontWeight="SemiBold"/>
                                        <TextBlock Text="{Binding Role}" Foreground="{ThemeResource AccentTextFillColorSecondaryBrush}"/>
                                        <TextBlock Text="{Binding StatusText}" Foreground="{Binding IsActive, Converter={StaticResource BoolToColorConverter}}"/>
                                    </StackPanel>
                                </DataTemplate>
                            </ListView.ItemTemplate>
                        </ListView>

                        <!-- User Form -->
                        <Border BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}" BorderThickness="1" CornerRadius="4" Padding="15">
                            <StackPanel Spacing="12">
                                <TextBlock Text="Información del Usuario" FontSize="16" FontWeight="SemiBold"/>

                                <Grid ColumnDefinitions="*,*" ColumnSpacing="10">
                                    <TextBox
                                        Grid.Column="0"
                                        Header="Nombre de Usuario"
                                        Text="{x:Bind UserManagementViewModel.Username, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                        PlaceholderText="usuario123"/>
                                    <TextBox
                                        Grid.Column="1"
                                        Header="Email"
                                        Text="{x:Bind UserManagementViewModel.Email, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                        PlaceholderText="usuario@empresa.com"/>
                                </Grid>

                                <TextBox
                                    Header="Nombre Completo"
                                    Text="{x:Bind UserManagementViewModel.Name, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                    PlaceholderText="Juan Pérez"/>

                                <ComboBox
                                    Header="Rol"
                                    ItemsSource="{x:Bind UserManagementViewModel.AvailableRoles}"
                                    SelectedItem="{x:Bind UserManagementViewModel.SelectedRole, Mode=TwoWay}"/>

                                <CheckBox
                                    Content="Puede emitir facturas"
                                    IsChecked="{x:Bind UserManagementViewModel.InInvoice, Mode=TwoWay}"/>

                                <!-- Password Section (only for new users) -->
                                <Border BorderBrush="{ThemeResource DividerStrokeColorDefaultBrush}" BorderThickness="0,1,0,0" Padding="0,10,0,0" Margin="0,10,0,0">
                                    <StackPanel Spacing="8">
                                        <TextBlock Text="Contraseña (solo para nuevos usuarios)" FontSize="14" FontWeight="SemiBold"/>
                                        <PasswordBox
                                            Header="Nueva Contraseña"
                                            Password="{x:Bind UserManagementViewModel.NewPassword, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                            PlaceholderText="Mínimo 6 caracteres"/>
                                        <PasswordBox
                                            Header="Confirmar Contraseña"
                                            Password="{x:Bind UserManagementViewModel.ConfirmPassword, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                            PlaceholderText="Repita la contraseña"/>
                                    </StackPanel>
                                </Border>

                                <!-- Change Password Section (for existing users) -->
                                <Border BorderBrush="{ThemeResource DividerStrokeColorDefaultBrush}" BorderThickness="0,1,0,0" Padding="0,10,0,0" Margin="0,10,0,0"
                                        Visibility="{x:Bind UserManagementViewModel.SelectedUser, Converter={StaticResource NullToVisibilityConverter}}">
                                    <StackPanel Spacing="8">
                                        <TextBlock Text="Cambiar Contraseña" FontSize="14" FontWeight="SemiBold"/>
                                        <PasswordBox
                                            Header="Contraseña Actual"
                                            Password="{x:Bind UserManagementViewModel.CurrentPassword, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>
                                        <PasswordBox
                                            Header="Nueva Contraseña"
                                            Password="{x:Bind UserManagementViewModel.NewPassword, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>
                                        <PasswordBox
                                            Header="Confirmar Nueva Contraseña"
                                            Password="{x:Bind UserManagementViewModel.ConfirmPassword, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>
                                        <Button
                                            Content="Cambiar Contraseña"
                                            Command="{x:Bind UserManagementViewModel.ChangePasswordCommand}"
                                            HorizontalAlignment="Left"/>
                                    </StackPanel>
                                </Border>
                            </StackPanel>
                        </Border>

                        <!-- Action Buttons -->
                        <StackPanel Orientation="Horizontal" Spacing="10" HorizontalAlignment="Right">
                            <Button
                                Content="Limpiar"
                                Command="{x:Bind UserManagementViewModel.ClearFormCommand}"/>
                            <Button
                                Content="Crear Usuario"
                                Command="{x:Bind UserManagementViewModel.CreateUserCommand}"
                                Background="{ThemeResource AccentButtonBackground}"
                                Foreground="{ThemeResource AccentButtonForeground}"/>
                            <Button
                                Content="Actualizar Usuario"
                                Command="{x:Bind UserManagementViewModel.UpdateUserCommand}"
                                IsEnabled="{x:Bind UserManagementViewModel.SelectedUser, Converter={StaticResource NullToBoolConverter}}"/>
                            <Button
                                Content="Eliminar Usuario"
                                Command="{x:Bind UserManagementViewModel.DeleteUserCommand}"
                                Background="{ThemeResource SystemFillColorCriticalBrush}"
                                IsEnabled="{x:Bind UserManagementViewModel.SelectedUser, Converter={StaticResource NullToBoolConverter}}"/>
                        </StackPanel>

                        <!-- User Status Actions -->
                        <StackPanel Orientation="Horizontal" Spacing="10" HorizontalAlignment="Right"
                                    Visibility="{x:Bind UserManagementViewModel.SelectedUser, Converter={StaticResource NullToVisibilityConverter}}">
                            <Button
                                Content="Activar Usuario"
                                Command="{x:Bind UserManagementViewModel.ActivateUserCommand}"
                                Background="{ThemeResource SystemFillColorSuccessBrush}"/>
                            <Button
                                Content="Desactivar Usuario"
                                Command="{x:Bind UserManagementViewModel.DeactivateUserCommand}"
                                Background="{ThemeResource SystemFillColorCautionBrush}"/>
                        </StackPanel>
                    </StackPanel>
                </ScrollViewer>
            </TabViewItem>
        </TabView>

        <!-- Action Buttons -->
        <StackPanel Grid.Row="2" Orientation="Horizontal" HorizontalAlignment="Right" Margin="20">
            <Button
                Content="Cargar Configuración"
                Command="{x:Bind ViewModel.LoadSettingsCommand}"
                Margin="0,0,10,0"
                IsEnabled="{x:Bind ViewModel.IsBusy, Mode=OneWay, Converter={StaticResource BoolNegationConverter}}"/>
            <Button
                Content="Guardar Configuración"
                Command="{x:Bind ViewModel.SaveSettingsCommand}"
                Background="{ThemeResource AccentButtonBackground}"
                Foreground="{ThemeResource AccentButtonForeground}"
                IsEnabled="{x:Bind ViewModel.IsBusy, Mode=OneWay, Converter={StaticResource BoolNegationConverter}}"/>
        </StackPanel>

        <!-- Loading Indicator -->
        <ProgressRing
            Grid.Row="1"
            IsActive="{x:Bind ViewModel.IsBusy, Mode=OneWay}"
            HorizontalAlignment="Center"
            VerticalAlignment="Center"
            Width="50"
            Height="50"/>
    </Grid>
</Page>